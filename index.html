<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <title>Game 3</title>
    <script src="//cdn.jsdelivr.net/phaser/2.2.2/phaser.min.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>

<script type="text/javascript">

    var map;
    var layer;

    var cursors;
    var sprite;
    var cherrys;
    var CherryText;
    var cherry = 0;
    var coins;
    var coin = 0;
    var CoinText;
    var stars;
    var star = 0;
    var StarText;
    var walls;
    var kisten;
    var trap;
    var crate;
    var stonebigs;
    var stonebig = 0;
    var explosion;
    var standingstill;
    var zombies;



    var Game = function () {

        this._width = 640;
        /*window.innerWidth;*/
        this._height = 640;
        /*window.innerHeight;*/

        this.game = new Phaser.Game(this._width, this._height, Phaser.CANVAS, '', {
            preload: this.preload,
            create: this.create,
            update: this.update,
            render: this.render,
            followPlayer: this.followPlayer,
            collectCherry: this.collectCherry,
            collectCoin: this.collectCoin,
            collectStar: this.collectStar,
            collectCrate: this.collectCrate
        });
    }


    Game.prototype = {
        preload: function () {
            var tilemapdebug = this.game.load.tilemap('map', 'map.json', null, Phaser.Tilemap.TILED_JSON);
            //console.log(tilemapdebug.tilesets);


            this.game.load.image('tiles', 'tmw_desert_spacing.png');
            this.game.load.image('cherry', 'cherry.png');
            this.game.load.spritesheet('coin', 'coin.png', 16, 16, 12);
            this.game.load.image('star', 'star.png');
            this.game.load.image('wall', 'wall.png');
            this.game.load.image('kisten', 'Crate32.png');
            this.game.load.image('crate', 'Crate64.png');
            this.game.load.image('trap', 'wall.png');
            this.game.load.image('stonebig', 'assets/stone.png');
            this.game.load.spritesheet('dude', 'standing-still.png', 32, 32);
            this.game.load.spritesheet('explosion', 'explosion.png', 32, 32, 10);
            this.game.load.spritesheet('zombies', 'assets/zombies/zombieMove.png', 32, 32);
        },

        create: function () {

            this.game.physics.startSystem(Phaser.Physics.ARCADE);

            // Load the map.
            map = this.game.add.tilemap('map');
            map.addTilesetImage('desert', 'tiles', 'coin', 'crate', 'crate32', 'star', 'stone', 'explosion', 'standing-still', 'ZombieMove');
            map.setCollisionBetween(1, 99);

            layer = map.createLayer('level1');

            layer.resizeWorld();
            layer.wrap = true;

            walls = this.game.add.group();
            walls.enableBody = true;
            this.game.physics.enable(walls);

            kisten = this.game.add.group();
            kisten.enableBody = true;
            this.game.physics.enable(kisten);

            cherrys = this.game.add.group();
            cherrys.enableBody = true;

            coins = this.game.add.group();
            coins.enableBody = true;

            crate = this.game.add.group();
            crate.enableBody = true;

            stars = this.game.add.group();
            stars.enableBody = true;

            stonebigs = this.game.add.group();
            stonebigs.enableBody = true;

            explosion = this.game.add.group();
            explosion.enableBody = true;

            standingstill = this.game.add.group();
            standingstill.enableBody = true;

            zombies = this.game.add.group();
            zombies.enableBody = true;

            map.createFromObjects('ol1', 10, 'wall', 0, true, false, walls);
            map.createFromObjects('ol1', 31, 'cherry', 0, true, false, cherrys);
            map.createFromObjects('ol1', 60, 'coin', 0, true, false, coins);
            map.createFromObjects('ol1', 72, 'crate', 0, true, false, crate);
            map.createFromObjects('ol1', 32, 'kisten', 0, true, false, kisten);
            map.createFromObjects('ol1', 34, 'trap', 0, true, false, trap);
            map.createFromObjects('ol1', 62, 'star', 0, true, false, stars);
            map.createFromObjects('ol1', 73, 'stonebig', 0, true, false, stonebigs);
            map.createFromObjects('ol1', 74, 'explosion', 0, true, false, explosion);
            map.createFromObjects('ol1', 89, 'dude', 0, true, false, standingstill);
            map.createFromObjects('ol1', 90, 'zombies', 0, true, false, zombies);


            walls.immovable = true;
            walls.moves = false;
            walls.setAll('body.immovable','body',true);

            kisten.immovable = false;
            kisten.moves = false;
            kisten.setAll('body.mass','body', 1);
            kisten.setAll('body.collideWorldBounds', true);

            stonebigs.immovable = false;
            stonebigs.moves = false;
            stonebigs.setAll('body.mass','body', 1);
            stonebigs.setAll('body.collideWorldBounds', true);

            crate.immovable = false;
            crate.moves = false;
            crate.setAll('body.mass','body', 1);
            crate.setAll('body.collideWorldBounds', true);

            console.log('Anzahl WÃ¤nde: ' + walls.length);
            console.log('Anzahl Kisten: ' + kisten.length);
            console.log('Anzahl Coins: ' + coins.length);
            console.log('Anzahl Kirschen: ' + cherrys.length);
            console.log('Anzahl crate: ' + crate.length);
            console.log('Anzahl star: ' + stars.length);
            console.log('Anzahl Stonebig: ' + stonebigs.length);

            sprite = this.game.add.sprite(10, 225, 'dude');
            sprite.anchor.setTo(0.5, 0.5);

            zombies = this.game.add.sprite(100, 350, 'zombies');
            zombies.anchor.setTo(0.5, 0.5);

            //sprite.scale.setTo(1, -1);

            this.game.physics.arcade.enable(sprite, Phaser.Physics.ARCADE);
            this.game.physics.arcade.enable(zombies, Phaser.Physics.ARCADE);
            sprite.body.collideWorldBounds = false;


            coins.callAll('animations.add', 'animations', 'spin', [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11], 10, true);
            coins.callAll('animations.play', 'animations', 'spin');

            explosion.callAll('animations.add', 'animations', 'explosions', [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11], 10, true);
            explosion.callAll('animations.play', 'animations', 'explosions');

            standingstill.callAll('animations.add', 'animations', 'walk', [0, 1, 2, 3, 4, 5], 10, true);
            standingstill.callAll('animations.play', 'animations', 'walk');

            zombies.callAll('animations.add', 'animations', 'zombieswalk', [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 15], 10, true);
            zombies.callAll('animations.play', 'animations', 'zombieswalk');

            var walk = sprite.animations.add('walk');
            var zombieswalk = zombies.animations.add('zombieswalk');

            CherryText = this.game.add.text(16, 8, 'Cherrys: 0', {fontSize: '32px', fill: '#000'});
            CoinText = this.game.add.text(16, 32, 'Coins: 0', {fontSize: '32px', fill: '#000'});
            StarText = this.game.add.text(16, 57, 'Stars: 0', {fontSize: '32px', fill: '#000'});

            //  This adjusts the collision body size.
            //sprite.body.setSize(16, 16, 0, 0);

            /*//  We'll set a lower max angular velocity here to keep it from going totally nuts
            sprite.body.maxAngular = 500;

            //  Apply a drag otherwise the sprite will just spin and never slow down
            sprite.body.angularDrag = 50;*/

            this.game.camera.follow(sprite, Phaser.Camera.FOLLOW_LOCKON, 0.1, 0.1);

            cursors = this.game.input.keyboard.createCursorKeys();
        },

        collectCherry: function (player, cherrys) {

            //alert(player);
            // Removes the coin from the screen
            console.log('cherry');
            cherrys.kill();

            cherry += 1;
            CherryText.text = 'Cherrys: ' + cherry;

        },
        collectCoin: function (player, coins) {

            //alert(player);
            // Removes the coin from the screen
            console.log('Coins');
            coins.kill();

            coin += 1;
            CoinText.text = 'Coins: ' + coin;

        },
        collectStar: function (player, stars) {

            //alert(player);
            // Removes the coin from the screen
            console.log('stars');
            stars.kill();

            star += 1;
            StarText.text = 'Stars: ' + star;

        },
        collectCrate: function (player, crate) {

            //alert(player);
            // Removes the coin from the screen
            crate.kill();
        },
        update: function () {

            //  Collide the player and the coins with the maps
            //this.game.physics.arcade.collide(sprite, boxes, this.collectBox);
            this.game.physics.arcade.overlap(sprite, cherrys, this.collectCherry);
            this.game.physics.arcade.overlap(sprite, coins, this.collectCoin);
            this.game.physics.arcade.overlap(sprite, stars, this.collectStar);
            this.game.physics.arcade.overlap(sprite, crate, this.collectCrate);
            this.game.physics.arcade.collide(sprite, walls);
            this.game.physics.arcade.collide(sprite, kisten);
            this.game.physics.arcade.collide(walls, kisten);
            this.game.physics.arcade.collide(sprite, crate);
            this.game.physics.arcade.collide(walls, crate);
            this.game.physics.arcade.collide(sprite, stonebigs);
            this.game.physics.arcade.collide(walls, stonebigs);
            this.game.physics.arcade.collide(sprite, zombies, this.followPlayer);


            sprite.body.velocity.x = 0;
            sprite.body.velocity.y = 0;
            sprite.body.angularVelocity = 0;
            /*sprite.width = 32;
            sprite.height = 32;*/

            if (this.game.input.keyboard.isDown(Phaser.Keyboard.LEFT))
            {
                sprite.body.angularVelocity = -150;
            }
            else if (this.game.input.keyboard.isDown(Phaser.Keyboard.RIGHT))
            {
                sprite.body.angularVelocity = 150;
            }

            if (this.game.input.keyboard.isDown(Phaser.Keyboard.UP))
            {
                sprite.animations.play('walk', 10, true);
                //prite.fixedRotation = true;
                //sprite.angle = 90;
                this.game.physics.arcade.velocityFromAngle(sprite.angle, 100, sprite.body.velocity);
            }
            else {
                sprite.animations.stop('walk', 10, true);
            }

            if (sprite.body.x < -30) {
                sprite.body.x = this.game._width-30;
            }
            if (sprite.body.x > 650) {
                sprite.body.x = this.game._width-650;
            }
            if (sprite.body.y < -50) {
                sprite.body.y = this.game._height-50;
            }
            if (sprite.body.y > 660) {
                sprite.body.y = this.game._height-650;
            }

            //Enemy AI follow player

        },

        followPlayer: function () {

                if (sprite.body.x < zombies.body.x)
                {
                    zombies.body.velocity.x = zombies.speed * -1;
                    sprite.animations.play('zombieswalk', 10, true);
                }
                else
                {
                    zombies.body.velocity.x = zombies.speed;
                    sprite.animations.stop('zombieswalk', 10, true);
                }
                if (sprite.body.y < zombies.body.y)
                {
                    zombies.body.velocity.y = zombies.speed * -1;
                    sprite.animations.play('zombieswalk', 10, true);
                }
                else
                {
                    zombies.body.velocity.y = zombies.speed;
                    sprite.animations.stop('zombieswalk', 10, true);
                }
        },

        render: function () {
            this.game.debug.bodyInfo(sprite, 32, 100);
        }
    };


    new Game();
</script>

</body>
</html>
